<html>
        <head>
                <title>Dike : Route Inflator</title>
                <meta charset="utf-8">
                <meta name="viewport" content="width=device-width, initial-scale=1">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
                </head>

        <body id="body">
                <script type="module">
                        import DikeWasm from "./DikeWasmES6.js";

                        let dikeModule  = null;
                        let dikeInstance= null;

                        let dikeTracks  = new Array();

                        function init () {
                                (async () => {
                                        await DikeWasm().then(function(Module) {
                                                console.log("dikeModuleES6 loaded");
                                                dikeModule = Module;
                                                var timePrev = (new Date()).getTime();
                                                dikeInstance = dikeModule._inflateCreate();
                                                dikeModule._inflateReset(dikeInstance);
                                                var timeThen = (new Date()).getTime();
                                                var timeElapsed = timeThen - timePrev;
                                                outputDike.innerHTML += "initialized in " + timeElapsed + "ms <br>";
                                        });
                                })();
                        }

                        function stringToUTF8Array (str) {
                                var utf8 = [];
                                for (var i = 0; i < str.length; i++) {
                                        var charcode = str.charCodeAt(i);
                                        if (charcode < 0x80) {
                                                utf8.push(charcode);
                                        } else if (charcode < 0x800) {
                                                utf8.push(0xc0 | (charcode >> 6),
                                                          0x80 | (charcode & 0x3f));
                                        } else if (charcode < 0xd800 || charcode >= 0xe000) {
                                                utf8.push(0xe0 | (charcode >> 12),
                                                          0x80 | ((charcode >> 6) & 0x3f),
                                                          0x80 | (charcode & 0x3f));
                                        } else {
                                                i++;
                                                charcode = ((charcode&0x3ff) << 10) | (str.charCodeAt(i) & 0x3ff) + 0x010000;
                                                utf8.push(0xf0 | (charcode >>18),
                                                          0x80 | ((charcode >> 12) & 0x3f),
                                                          0x80 | ((charcode >> 6) & 0x3f),
                                                          0x80 | (charcode & 0x3f));
                                        }
                                }
                                utf8.push(0x00);
                                return utf8;
                        }

                        let stringFromUtf8 = function (data) {
                                var str = "";
                                var i;
                                for (i = 0; i < data.length; i++) {
                                        var value = data[i];

                                        if (value == 0) {
                                                break;
                                        } else if (value < 0x80) {
                                                str += String.fromCharCode(value);
                                        } else if (value > 0xBF && value < 0xE0) {
                                                str += String.fromCharCode((value & 0x1F) << 6 | data[i + 1] & 0x3F);
                                                i += 1;
                                        } else if (value > 0xDF && value < 0xF0) {
                                                str += String.fromCharCode((value & 0x0F) << 12 | (data[i + 1] & 0x3F) << 6 | data[i + 2] & 0x3F);
                                                i += 2;
                                        } else {
                                                var charCode = ((value & 0x07) << 18 | (data[i + 1] & 0x3F) << 12 | (data[i + 2] & 0x3F) << 6 | data[i + 3] & 0x3F) - 0x010000;
                                                str += String.fromCharCode(charCode >> 10 | 0xD800, charCode & 0x03FF | 0xDC00);
                                                i += 3;
                                        }
                                }
                                return str;
                        }

                        let inputDikeTrackDel = function (idx) {
                                dikeTracks.splice(idx, 1);

                                let innerHTML = "";

                                if (dikeTracks.length == 0) {
                                        innerHTML += "(empty)";
                                } else {
                                        innerHTML += ``;
                                        innerHTML += `<div>`;
                                        for (let i = 0; i < dikeTracks.length; i++) {
                                                innerHTML += `<p onclick="inputDikeTrackDel(${i});">${dikeTracks[i].name}</p>`;
                                        }
                                        innerHTML += `</div>`;
                                }

                                inputDikeTracksList.innerHTML = innerHTML;

                                dikeResult.innerHTML = "Add base tracks, then kick 'Inflate'.";
                        }

                        inputDikeTrackAdd.onclick = function (event) {
                                inputDikeTrackAddSelectFile.click();
                        }

                        inputDikeTrackAddSelectFile.onchange = function (event) {
                                for (let i = 0; i < event.target.files.length; i++) {
                                        let file = event.target.files[i];
                                        dikeTracks.push(file);
                                }

                                let innerHTML = "";

                                if (dikeTracks.length == 0) {
                                        innerHTML += "(empty)";
                                } else {
                                        innerHTML += ``;
                                        innerHTML += `<div>`;
                                        for (let i = 0; i < dikeTracks.length; i++) {
                                                innerHTML += `<p onclick="inputDikeTrackDel(${i});">${dikeTracks[i].name}</p>`;
                                        }
                                        innerHTML += `</div>`;
                                }

                                inputDikeTracksList.innerHTML = innerHTML;

                                dikeResult.innerHTML = "Add base tracks, then kick 'Inflate'.";
                        }

                        dikeInflateButton.onclick = function (event) {
                                dikeModule._inflateReset(dikeInstance);

                                let load;
                                var timePrev = (new Date()).getTime();

                                let format         = document.getElementById("dikeFormat").value;
                                let coverageRadius = parseInt(document.getElementById("dikeCoverageRadius").value);
                                let formatUTF8     = stringToUTF8Array(format);
                                let formatRaw      = dikeModule._malloc(formatUTF8.length);;
                                dikeModule.HEAPU8.set(formatUTF8, formatRaw);
                                dikeModule._inflateSetOptions(dikeInstance, formatRaw, coverageRadius);
                                dikeModule._free(formatRaw);

                                load = 0;

                                if (dikeTracks.length == 0) {
                                        dikeResult.innerHTML = "Add base tracks, then kick 'Inflate'.";
                                        outputDike.innerHTML = "No tracks to process.<br>";
                                        return;
                                }

                                dikeResult.innerHTML = "Inflating...";
                                window.scrollTo(0, 0);

                                outputDike.innerHTML = "loading tracks<br>";

                                for (let i = 0; i < dikeTracks.length; i++) {
                                        let file = dikeTracks[i];
                                        let fileReader = new FileReader();
                                        fileReader.onload = function (event) {
                                                let uint8Array = new Uint8Array(event.target.result);
                                                let raw = dikeModule._malloc(uint8Array.length);
                                                dikeModule.HEAPU8.set(uint8Array, raw);
                                                let rc = dikeModule._inflateAddTrack(dikeInstance, raw, uint8Array.length);
                                                if (rc != 0) {
                                                        outputDike.innerHTML += `can not load: ${dikeTracks[i].name}, rc: ${rc}<br>`;
                                                }
                                                dikeModule._free(raw);

                                                load += 1;
                                                if (load == dikeTracks.length) {
                                                        var timeThen = (new Date()).getTime();
                                                        var timeElapsed = timeThen - timePrev;
                                                        outputDike.innerHTML += "loaded in " + timeElapsed + "ms <br>";

                                                        timePrev = (new Date()).getTime();
                                                        let inflateResult = dikeModule._inflateInflate(dikeInstance);
                                                        let inflateLength = dikeModule.getValue(inflateResult + 0, 'i32');
                                                        let inflateBuffer = dikeModule.getValue(inflateResult + 4, '*');
                                                        const inflatedData = new Uint8Array(dikeModule.HEAPU8.buffer, inflateBuffer, inflateLength);
                                                        const inflatedCopy = new Uint8Array(inflatedData);
                                                        dikeModule._free(inflateBuffer);
                                                        dikeModule._free(inflateResult);

                                                        timeThen = (new Date()).getTime();
                                                        timeElapsed = timeThen - timePrev;
                                                        outputDike.innerHTML += "inflated in " + timeElapsed + "ms <br>";

                                                        const mime = (format === 'kml') ? 'application/vnd.google-earth.kml+xml' : 'application/gpx+xml';
                                                        const blob = new Blob([inflatedCopy], { type: mime });
                                                        const url = URL.createObjectURL(blob);
                                                        const fileName = `inflated.${format}`;

                                                        dikeResult.innerHTML = 'Download: ';
                                                        const a = document.createElement('a');
                                                        a.href = url;
                                                        a.download = fileName;
                                                        a.textContent = fileName;
                                                        a.addEventListener('click', () => {
                                                                setTimeout(() => {
                                                                        URL.revokeObjectURL(url);
                                                                        dikeResult.innerHTML = "Add base tracks, then kick 'Inflate'.";
                                                                        outputDike.innerHTML = "Waiting for tracks...<br>";
                                                                }, 0);
                                                        });
                                                        dikeResult.appendChild(a);
                                                        dikeResult.insertAdjacentHTML('beforeend', '<br>');
                                                        outputDike.innerHTML += `<p>`;
                                                        outputDike.innerHTML += `format: ${format}<br>`;
                                                        outputDike.innerHTML += `length: ${inflateLength}<br>`;
                                                        outputDike.innerHTML += `</p>`;
                                                }
                                        }
                                        outputDike.innerHTML += `loading: ${dikeTracks[i].name}<br>`;
                                        fileReader.readAsArrayBuffer(file);
                                }
                        }

                        dikeResult.innerHTML = "Add base tracks, then kick 'Inflate'.";
                        inputDikeTracksList.innerHTML = "(empty)";

                        window.inputDikeTrackDel = inputDikeTrackDel;

                        window.addEventListener("load", init, false);
                </script>
                <div class="container py-4">
                        <div class="row justify-content-center">
                                <div class="col-lg-10">
                                        <h1 class="text-center mb-4">
                                                <i class="bi bi-layers"></i> Dike : Route Inflator
                                        </h1>

                                        <div id="dikeResult" class="alert alert-info text-center shadow-sm mb-4" role="alert">
                                                <i class="bi bi-info-circle"></i> Add base tracks, then kick 'Inflate'.
                                        </div>

                                        <div class="card shadow-sm mb-3">
                                                <div class="card-body">
                                                        <h5 class="card-title mb-3">
                                                                <i class="bi bi-map"></i> GPS Tracks
                                                        </h5>
                                                        <div id="inputDikeTracksList" class="mb-3 p-3 bg-light rounded" style="min-height: 120px;">
                                                        </div>
                                                        <button id="inputDikeTrackAdd" type="button" class="w-100 btn btn-outline-primary">
                                                                <i class="bi bi-plus-circle"></i> Add Track
                                                        </button>
                                                        <input id="inputDikeTrackAddSelectFile" type="file" name="name" style="display: none;" multiple />
                                                        <small class="text-muted d-block mt-2">
                                                                <i class="bi bi-file-earmark"></i> Supports GPX, KML, and KMZ files
                                                        </small>
                                                </div>
                                        </div>

                                        <div class="card shadow-sm mb-4">
                                                <div class="card-body">
                                                        <h5 class="card-title mb-4">
                                                                <i class="bi bi-gear"></i> Inflation Settings
                                                        </h5>
                                                        <div class="row g-3 mb-3">
                                                                <div class="col-md-6">
                                                                        <label for="dikeFormat" class="form-label fw-bold">Output Format</label>
                                                                        <select id="dikeFormat" class="form-select">
                                                                                <option value="kml" selected>KML (Keyhole Markup Language)</option>
                                                                                <option value="gpx">GPX (GPS Exchange Format)</option>
                                                                        </select>
                                                                        <small class="text-muted">Choose the format for the inflated corridor output</small>
                                                                </div>
                                                                <div class="col-md-6">
                                                                        <label for="dikeCoverageRadius" class="form-label fw-bold">Coverage Radius (meters)</label>
                                                                        <input id="dikeCoverageRadius" type="number" class="form-control" placeholder="Coverage Radius" value="250" min="1" />
                                                                        <small class="text-muted">Buffer distance around the track centerline</small>
                                                                </div>
                                                        </div>
                                                        <button id="dikeInflateButton" type="button" class="w-100 btn btn-primary btn-lg">
                                                                <i class="bi bi-arrow-bar-up"></i> Generate Corridor
                                                        </button>
                                                </div>
                                        </div>
                                </div>
                        </div>
                </div>

                <div class="container py-3">
                        <div class="row justify-content-center">
                                <div class="col-lg-10">
                                        <div class="card shadow-sm">
                                                <div class="card-header bg-light">
                                                        <h5 class="mb-0"><i class="bi bi-terminal"></i> Processing Output</h5>
                                                </div>
                                                <div id="outputDike" class="card-body font-monospace" style="min-height: 100px; font-size: 0.9rem;">
                                                </div>
                                        </div>
                                </div>
                        </div>
                </div>

                <footer class="text-center py-4 mt-5 border-top bg-white">
                        <small class="text-muted">
                                <a href="/dike" class="text-decoration-none">Dike</a>  is an open-source route suite for GPS tracks.<br>
                                Source code and documentation available at:
                                <a href="https://github.com/alperakcan/dike" target="_blank" class="text-decoration-none">
                                        <i class="bi bi-github"></i> github.com/alperakcan/dike
                                </a>
                        </small>
                </footer>
        </body>
</html>

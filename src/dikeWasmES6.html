<html>
        <head>
                <meta charset="utf-8"></meta>
                <title>dike.wasm</title>
        </head>

        <body id="body">
                <script type="module">
                        import DikeWasm from "./DikeWasmES6.js";

                        let dikeModule  = null;
                        let dikeInstance= null;

                        let dikeTracks  = new Array();
                        let dikeRecords = new Array();

                        function init () {
                                (async () => {
                                        await DikeWasm().then(function(Module) {
                                                console.log("dikeModuleES6 loaded");
                                                dikeModule = Module;
                                                var timePrev = (new Date()).getTime();
                                                dikeInstance = dikeModule._create();
                                                dikeModule._reset(dikeInstance);
                                                var timeThen = (new Date()).getTime();
                                                var timeElapsed = timeThen - timePrev;
                                                outputDike.innerHTML += "initialized in " + timeElapsed + "ms <br>";
                                        });
                                })();
                        }

                        function stringToUTF8Array (str) {
                                var utf8 = [];
                                for (var i = 0; i < str.length; i++) {
                                        var charcode = str.charCodeAt(i);
                                        if (charcode < 0x80) {
                                                utf8.push(charcode);
                                        } else if (charcode < 0x800) {
                                                utf8.push(0xc0 | (charcode >> 6),
                                                          0x80 | (charcode & 0x3f));
                                        } else if (charcode < 0xd800 || charcode >= 0xe000) {
                                                utf8.push(0xe0 | (charcode >> 12),
                                                          0x80 | ((charcode >> 6) & 0x3f),
                                                          0x80 | (charcode & 0x3f));
                                        } else {
                                                i++;
                                                charcode = ((charcode&0x3ff) << 10) | (str.charCodeAt(i) & 0x3ff) + 0x010000;
                                                utf8.push(0xf0 | (charcode >>18),
                                                          0x80 | ((charcode >> 12) & 0x3f),
                                                          0x80 | ((charcode >> 6) & 0x3f),
                                                          0x80 | (charcode & 0x3f));
                                        }
                                }
                                utf8.push(0x00);
                                return utf8;
                        }

                        let stringFromUtf8 = function (data) {
                                var str = "";
                                var i;
                                for (i = 0; i < data.length; i++) {
                                        var value = data[i];

                                        if (value == 0) {
                                                break;
                                        } else if (value < 0x80) {
                                                str += String.fromCharCode(value);
                                        } else if (value > 0xBF && value < 0xE0) {
                                                str += String.fromCharCode((value & 0x1F) << 6 | data[i + 1] & 0x3F);
                                                i += 1;
                                        } else if (value > 0xDF && value < 0xF0) {
                                                str += String.fromCharCode((value & 0x0F) << 12 | (data[i + 1] & 0x3F) << 6 | data[i + 2] & 0x3F);
                                                i += 2;
                                        } else {
                                                var charCode = ((value & 0x07) << 18 | (data[i + 1] & 0x3F) << 12 | (data[i + 2] & 0x3F) << 6 | data[i + 3] & 0x3F) - 0x010000;
                                                str += String.fromCharCode(charCode >> 10 | 0xD800, charCode & 0x03FF | 0xDC00);
                                                i += 3;
                                        }
                                }
                                return str;
                        }

                        let inputDikeTrackDel = function (idx) {
                                dikeTracks.splice(idx, 1);

                                let innerHTML = "";

                                if (dikeTracks.length == 0) {
                                        innerHTML = "(empty)";
                                } else {
                                        innerHTML  = `<table>`;
                                        for (let i = 0; i < dikeTracks.length; i++) {
                                                console.log(dikeTracks[i].name);
                                                innerHTML += `<tr><td onclick="inputDikeTrackDel(${i});">- ${dikeTracks[i].name}</td></tr>`;
                                        }
                                        innerHTML += `</table>`;
                                }

                                inputDikeTracksList.innerHTML = innerHTML;
                        }

                        inputDikeTrackAdd.onclick = function (event) {
                                inputDikeTrackAddSelectFile.click();
                        }

                        inputDikeTrackAddSelectFile.onchange = function (event) {
                                for (let i = 0; i < event.target.files.length; i++) {
                                        let file = event.target.files[i];
                                        dikeTracks.push(file);
                                }

                                let innerHTML = "";

                                if (dikeTracks.length == 0) {
                                        innerHTML = "(empty)";
                                } else {
                                        innerHTML  = `<table>`;
                                        for (let i = 0; i < dikeTracks.length; i++) {
                                                innerHTML += `<tr><td onclick="inputDikeTrackDel(${i});">- ${dikeTracks[i].name}</td></tr>`;
                                        }
                                        innerHTML += `</table>`;
                                }

                                inputDikeTracksList.innerHTML = innerHTML;
                        }

                        let inputDikeRecordDel = function (idx) {
                                dikeRecords.splice(idx, 1);

                                let innerHTML = "";

                                if (dikeRecords.length == 0) {
                                        innerHTML = "(empty)";
                                } else {
                                        innerHTML  = `<table>`;
                                        for (let i = 0; i < dikeRecords.length; i++) {
                                                console.log(dikeRecords[i].name);
                                                innerHTML += `<tr><td onclick="inputDikeRecordDel(${i});">- ${dikeRecords[i].name}</td></tr>`;
                                        }
                                        innerHTML += `</table>`;
                                }

                                inputDikeRecordsList.innerHTML = innerHTML;
                        }

                        inputDikeRecordAdd.onclick = function (event) {
                                inputDikeRecordAddSelectFile.click();
                        }

                        inputDikeRecordAddSelectFile.onchange = function (event) {
                                for (let i = 0; i < event.target.files.length; i++) {
                                        let file = event.target.files[i];
                                        dikeRecords.push(file);
                                }

                                let innerHTML = "";

                                if (dikeRecords.length == 0) {
                                        innerHTML = "(empty)";
                                } else {
                                        innerHTML  = `<table>`;
                                        for (let i = 0; i < dikeRecords.length; i++) {
                                                innerHTML += `<tr><td onclick="inputDikeRecordDel(${i});">- ${dikeRecords[i].name}</td></tr>`;
                                        }
                                        innerHTML += `</table>`;
                                }

                                inputDikeRecordsList.innerHTML = innerHTML;
                        }

                        dikeCalculateButton.onclick = function (event) {
                                dikeModule._reset(dikeInstance);

                                let method = inputDikeMethod.value;
                                let methodUTF8     = stringToUTF8Array(method);
                                let methodRaw      = dikeModule._malloc(methodUTF8.length);;
                                dikeModule.HEAPU8.set(methodUTF8, methodRaw);
                                dikeModule._setMethod(dikeInstance, methodRaw);
                                dikeModule._free(methodRaw);

                                for (let i = 0; i < dikeTracks.length; i++) {
                                        let file = dikeTracks[i];
                                        let fileReader = new FileReader();
                                        fileReader.onload = function (event) {
                                                let uint8Array = new Uint8Array(event.target.result);
                                                let raw = dikeModule._malloc(uint8Array.length);
                                                dikeModule.HEAPU8.set(uint8Array, raw);
                                                let rc = dikeModule._addTrack(dikeInstance, raw, uint8Array.length);
                                                if (rc != 0) {
                                                        outputDike.innerHTML += `can not load: ${dikeTracks[i].name}, rc: ${rc}<br>`;
                                                } else {
                                                        outputDike.innerHTML += `load: ${dikeTracks[i].name}, rc: ${rc}<br>`;
                                                }
                                                dikeModule._free(raw);
                                        }
                                        fileReader.readAsArrayBuffer(file);
                                }

                                for (let i = 0; i < dikeRecords.length; i++) {
                                        let file = dikeRecords[i];
                                        let fileReader = new FileReader();
                                        fileReader.onload = function (event) {
                                                let uint8Array = new Uint8Array(event.target.result);
                                                let raw = dikeModule._malloc(uint8Array.length);
                                                dikeModule.HEAPU8.set(uint8Array, raw);
                                                let rc = dikeModule._addRecord(dikeInstance, raw, uint8Array.length);
                                                if (rc != 0) {
                                                        outputDike.innerHTML += `can not load: ${dikeRecords[i].name}, rc: ${rc}<br>`;
                                                } else {
                                                        outputDike.innerHTML += `load: ${dikeRecords[i].name}, rc: ${rc}<br>`;
                                                }
                                                dikeModule._free(raw);
                                        }
                                        fileReader.readAsArrayBuffer(file);
                                }
                        }

                        inputDikeMethod.value = "quadtree";
                        inputDikeTracksList.innerHTML = "(empty)";

                        window.inputDikeTrackDel = inputDikeTrackDel;
                        window.inputDikeRecordDel = inputDikeRecordDel;

                        window.addEventListener("load", init, false);
                </script>
                <table style="border-collapse: separate; border-spacing: 1em;">
                        <tr>
                                <td>method</td>
                                <td>
                                        <select id="inputDikeMethod" name="name">
                                                <option value="bruteforce">bruteforce</option>
                                                <option value="quadtree">quadtree</option>
                                        </select>
                                </td>
                        </tr>
                        <tr>
                                <td valign="top">tracks</td>
                                <td>
                                        <table>
                                                <tr>
                                                        <td id="inputDikeTracksList">
                                                                (empty)
                                                        </td>
                                                </tr>
                                                <tr>
                                                        <td id="inputDikeTrackAdd">
                                                                + add track
                                                        </td>
                                                </tr>
                                        </table>
                                </td>
                                <td><input id="inputDikeTrackAddSelectFile" type="file" name="name" style="display: none;" multiple /></td>
                        </tr>
                        <tr>
                                <td valign="top">records</td>
                                <td>
                                        <table>
                                                <tr>
                                                        <td id="inputDikeRecordsList">
                                                                (empty)
                                                        </td>
                                                </tr>
                                                <tr>
                                                        <td id="inputDikeRecordAdd">
                                                                + add record
                                                        </td>
                                                </tr>
                                        </table>
                                </td>
                                <td><input id="inputDikeRecordAddSelectFile" type="file" name="name" style="display: none;" multiple /></td>
                        </tr>
                        <tr>
                                <td></td>
                                <td><button id="dikeCalculateButton">calculate</button></td>
                        </tr>
                        <tr>
                                <td>
                                        <p id="outputDike"></p>
                                </td>
                        </tr>
                </table>
        </body>
</html>
